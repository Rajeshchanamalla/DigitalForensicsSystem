<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Analytics - Digital Forensics</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <h3>ðŸ”’ Digital Forensic System</h3>
      <div class="nav-links">
        <a href="admin-dashboard.html">Dashboard</a>
        <a href="advanced-analytics.html" class="active">Advanced Analytics</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>ðŸ“Š Advanced Analytics Dashboard</h1>
      <p class="subtitle">Comprehensive evidence analytics and insights</p>
    </div>

    <div class="analytics-filters" style="margin-bottom: 30px;">
      <div class="form-group" style="display: inline-block; margin-right: 15px;">
        <label for="dateFrom">From Date:</label>
        <input type="date" id="dateFrom">
      </div>
      <div class="form-group" style="display: inline-block; margin-right: 15px;">
        <label for="dateTo">To Date:</label>
        <input type="date" id="dateTo">
      </div>
      <button onclick="loadAnalytics()" class="btn-primary">Load Analytics</button>
      <button onclick="exportAnalytics()" class="btn-secondary">Export Data</button>
    </div>

    <div class="analytics-grid">
      <div class="analytics-card">
        <h3>Evidence Trends Over Time</h3>
        <canvas id="trendsChart"></canvas>
      </div>

      <div class="analytics-card">
        <h3>Category Distribution</h3>
        <canvas id="categoryChart"></canvas>
      </div>

      <div class="analytics-card">
        <h3>Status Distribution</h3>
        <canvas id="statusChart"></canvas>
      </div>

      <div class="analytics-card">
        <h3>Investigator Performance</h3>
        <div id="investigatorTable"></div>
      </div>
    </div>
  </div>
  <script src="env-config.js"></script>

  <script src="config.js"></script>
  <script src="enhanced-features.js"></script>
  <script src="app.js"></script>
  <script>
    let trendsChart, categoryChart, statusChart;

    async function loadAnalytics() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      try {
        const analytics = await EnhancedFeatures.getAdvancedAnalytics(dateFrom, dateTo);

        // Update trends chart
        updateTrendsChart(analytics.trends);

        // Update category chart
        updateCategoryChart(analytics.categoryDistribution);

        // Update status chart
        updateStatusChart(analytics.statusDistribution);

        // Update investigator table
        updateInvestigatorTable(analytics.investigatorPerformance);
      } catch (error) {
        alert('Error loading analytics: ' + error.message);
        console.error('Analytics error:', error);
      }
    }

    function updateTrendsChart(trends) {
      const ctx = document.getElementById('trendsChart').getContext('2d');
      const dates = [...new Set(trends.map(t => t.date))].sort();
      const statuses = ['pending', 'verified', 'rejected', 'archived'];

      const datasets = statuses.map(status => ({
        label: status,
        data: dates.map(date => {
          const entry = trends.find(t => t.date === date && t.status === status);
          return entry ? entry.count : 0;
        }),
        borderColor: getStatusColor(status),
        backgroundColor: getStatusColor(status) + '40',
        tension: 0.1
      }));

      if (trendsChart) trendsChart.destroy();
      trendsChart = new Chart(ctx, {
        type: 'line',
        data: { labels: dates, datasets },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function updateCategoryChart(categories) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      if (categoryChart) categoryChart.destroy();
      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: categories.map(c => c.category || 'Uncategorized'),
          datasets: [{
            data: categories.map(c => c.count),
            backgroundColor: categories.map((_, i) => getColor(i))
          }]
        },
        options: { responsive: true }
      });
    }

    function updateStatusChart(statusDist) {
      const ctx = document.getElementById('statusChart').getContext('2d');
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: statusDist.map(s => s.status),
          datasets: [{
            label: 'Count',
            data: statusDist.map(s => s.count),
            backgroundColor: statusDist.map(s => getStatusColor(s.status) + '80')
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function updateInvestigatorTable(investigators) {
      const table = document.getElementById('investigatorTable');
      let html = '<table class="evidence-table"><thead><tr><th>Investigator</th><th>Total</th><th>Verified</th><th>Rate</th></tr></thead><tbody>';
      investigators.forEach(inv => {
        const rate = inv.total > 0 ? ((inv.verified / inv.total) * 100).toFixed(1) : 0;
        html += `<tr><td>${inv.investigatorId}</td><td>${inv.total}</td><td>${inv.verified}</td><td>${rate}%</td></tr>`;
      });
      html += '</tbody></table>';
      table.innerHTML = html;
    }

    function getStatusColor(status) {
      const colors = {
        'pending': '#fbbf24',
        'verified': '#10b981',
        'rejected': '#f87171',
        'archived': '#9ca3af'
      };
      return colors[status] || '#6b7280';
    }

    function getColor(index) {
      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#ec4899', '#6b7280'];
      return colors[index % colors.length];
    }

    function exportAnalytics() {
      // Export analytics data as CSV
      alert('Export functionality - Coming soon!');
    }

    // Load analytics on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Set default date range (last 30 days)
      const today = new Date();
      const lastMonth = new Date(today);
      lastMonth.setDate(lastMonth.getDate() - 30);
      document.getElementById('dateTo').value = today.toISOString().split('T')[0];
      document.getElementById('dateFrom').value = lastMonth.toISOString().split('T')[0];
      
      loadAnalytics();
    });
  </script>
</body>
</html>

